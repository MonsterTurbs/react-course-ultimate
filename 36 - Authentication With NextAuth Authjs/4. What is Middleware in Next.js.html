

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Next.js Middleware ‚Äî Reviewer / Study Guide</title>
  <style>
    :root {
      --bg: #ffffff;
      --text: #111111;
      --muted: #5a5a5a;
      --border: #e6e6e6;
      --soft: #fafafa;
      --chip: #f3f4f6;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: Arial, Helvetica, sans-serif;
      line-height: 1.6;
      overflow-wrap: anywhere;
      word-break: normal;
      hyphens: auto;
    }

    /* Single-column page */
    .page {
      max-width: 820px;
      margin: 0 auto;
      padding: 22px 18px;
    }

    header {
      padding: 14px 0 10px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 16px;
    }

    h1 {
      font-size: 24px;
      margin: 0 0 6px;
      letter-spacing: -0.2px;
    }

    .subtitle {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

    h2 {
      font-size: 18px;
      margin: 18px 0 8px;
      padding-top: 8px;
      border-top: 1px solid var(--border);
    }

    h3 {
      font-size: 15px;
      margin: 14px 0 6px;
    }

    p { margin: 8px 0; }

    ul {
      margin: 8px 0 10px 18px;
      padding: 0;
    }

    li { margin: 6px 0; }

    .card {
      border: 1px solid var(--border);
      background: var(--soft);
      border-radius: 10px;
      padding: 12px 12px;
      margin: 10px 0;
    }

    .chips { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .chip {
      display: inline-block;
      padding: 4px 8px;
      border: 1px solid var(--border);
      background: var(--chip);
      border-radius: 999px;
      font-size: 12px;
      color: #222;
    }

    .callout {
      border-left: 5px solid #111;
      padding: 10px 12px;
      background: #fff;
      border: 1px solid var(--border);
      border-left-width: 5px;
      border-radius: 10px;
      margin: 12px 0;
    }

    .callout .title {
      font-weight: 700;
      margin-bottom: 4px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin: 10px 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 13px;
    }
    th, td {
      border: 1px solid var(--border);
      padding: 8px 10px;
      vertical-align: top;
    }
    th {
      background: var(--soft);
      text-align: left;
      font-weight: 700;
    }

    code, pre {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    pre {
      margin: 10px 0;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #ffffff;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .mini {
      font-size: 12px;
      color: var(--muted);
    }

    .diagram {
      border: 1px dashed var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      background: #fff;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-word;
      margin: 10px 0;
    }

    /* Print */
    @page { size: A4; margin: 14mm; }

    @media print {
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .page { padding: 0; max-width: none; }
      a, a:visited { color: inherit; text-decoration: none; }
      /* Prevent browsers from appending URLs after links */
      a[href]::after { content: "" !important; }
      pre, .card, .callout, table { page-break-inside: avoid; }
      h2, h3 { page-break-after: avoid; }
    }
  </style>
</head>
<body>
  <main class="page">
    <header>
      <h1>Next.js Middleware ‚Äî Reviewer / Study Guide</h1>
      <p class="subtitle">Topic: What Middleware is, when it runs, and why it‚Äôs useful for authorization üîê</p>
      <div class="chips" aria-label="quick-tags">
        <span class="chip">Next.js App Router</span>
        <span class="chip">Authorization</span>
        <span class="chip">Cookies & Headers</span>
        <span class="chip">Redirect / Rewrite</span>
        <span class="chip">Matcher</span>
      </div>
    </header>

    <section>
      <h2>1) What is Middleware?</h2>
      <p><strong>Middleware</strong> is code that runs <strong>between</strong> an incoming request and the response that your app sends back. üß©</p>
      <p>In Next.js, middleware is a <strong>single exported function</strong> that can inspect the incoming request (URL, headers, cookies, etc.) and then decide what should happen <strong>before</strong> the requested route is rendered.</p>

      <div class="diagram" aria-label="request-response-flow">
Request ‚Üí (Middleware runs here) ‚Üí Route renders (page/route handler) ‚Üí Response
      </div>

      <div class="callout">
        <div class="title">Key idea ‚úÖ</div>
        <p>Think of middleware like ‚Äúcommon code‚Äù that you would otherwise copy-paste into many routes ‚Äî except middleware keeps it in <strong>one central place</strong>, keeping pages/components cleaner.</p>
      </div>
    </section>

    <section>
      <h2>2) When does Middleware run?</h2>
      <ul>
        <li>By default, middleware can run <strong>before many routes</strong> in your Next.js app.</li>
        <li>It runs <strong>after the request arrives</strong> but <strong>before</strong> the route is rendered and sent back.</li>
        <li>You can restrict which routes it applies to using a <strong>matcher</strong> (recommended).</li>
      </ul>

      <div class="card">
        <h3>Why is the ‚Äúbefore render‚Äù timing useful? ü§î</h3>
        <p>Because you can make decisions early ‚Äî for example:</p>
        <ul>
          <li>Redirect logged-out users away from protected pages</li>
          <li>Rewrite requests to different routes</li>
          <li>Read cookies/headers to determine who the user is</li>
        </ul>
      </div>
    </section>

    <section>
      <h2>3) Where do we put Middleware files?</h2>
      <p>Create a file named <code>middleware.js</code> (or <code>middleware.ts</code>) in the <strong>root</strong> of your Next.js project.</p>
      <p class="mini">Important: it goes in the project root (same level as <code>package.json</code>), <strong>not</strong> inside the <code>app/</code> folder.</p>

      <div class="diagram" aria-label="project-structure">
project-root/
  app/
  public/
  middleware.js   ‚Üê here
  package.json
      </div>
    </section>

    <section>
      <h2>4) What is Middleware used for?</h2>
      <p>The most important capability of middleware is working with <strong>cookies and headers</strong>:</p>
      <ul>
        <li>üì• Read incoming cookies/headers (example: session cookie)</li>
        <li>üì§ Set cookies/headers on the response</li>
      </ul>

      <table aria-label="middleware-use-cases">
        <thead>
          <tr>
            <th>Use case</th>
            <th>What middleware does</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Authentication / Authorization üîê</td>
            <td>Checks if a user is logged in; redirects if not.</td>
          </tr>
          <tr>
            <td>Redirects / Rewrites ‚Ü™Ô∏è</td>
            <td>Moves users to a different route based on rules (e.g., locale, feature flag).</td>
          </tr>
          <tr>
            <td>A/B testing üß™</td>
            <td>Assigns a user to a variation via cookies; routes accordingly.</td>
          </tr>
          <tr>
            <td>Geo-based behavior üåç</td>
            <td>Uses headers to infer region and serve localized content.</td>
          </tr>
          <tr>
            <td>Server-side analytics üìä</td>
            <td>Logs request metadata before rendering.</td>
          </tr>
        </tbody>
      </table>
    </section>

    <section>
      <h2>5) Middleware must return a Response</h2>
      <p>A middleware function must always produce a response. There are two common patterns:</p>

      <div class="grid">
        <div class="card">
          <h3>A) Continue / Redirect / Rewrite (most common) ‚úÖ</h3>
          <ul>
            <li><strong>Continue</strong>: allow the route to render normally.</li>
            <li><strong>Redirect</strong>: send the user somewhere else (e.g., to <code>/login</code>).</li>
            <li><strong>Rewrite</strong>: internally map to a different route without changing the visible URL.</li>
          </ul>
        </div>

        <div class="card">
          <h3>B) Return JSON directly (route is bypassed) ‚ö†Ô∏è</h3>
          <p>You can return JSON straight from middleware, which <strong>skips</strong> rendering the route completely.</p>
          <p class="mini">This can mimic an API response, but most apps prefer Route Handlers for APIs.</p>
        </div>
      </div>
    </section>

    <section>
      <h2>6) Practical example: Protecting a ‚ÄúGuest Area‚Äù route</h2>
      <p>In authorization, the goal is: <strong>only logged-in users can access certain routes</strong> (example: <code>/account</code> or <code>/guest-area</code>).</p>

      <div class="callout">
        <div class="title">Mental model üß†</div>
        <p>If request is for a protected route AND user is not logged in ‚Üí redirect to login.</p>
      </div>

      <h3>Example middleware (basic pattern)</h3>
      <pre><code>// middleware.js (project root)
import { NextResponse } from "next/server";

export function middleware(request) {
  // 1) Read something from the incoming request
  // Example: a cookie that indicates a logged-in session
  const sessionCookie = request.cookies.get("session")?.value;

  // 2) If user is NOT logged in, redirect them away
  if (!sessionCookie) {
    const loginUrl = new URL("/login", request.url);
    // Optionally preserve where they were going:
    loginUrl.searchParams.set("redirectTo", request.nextUrl.pathname);
    return NextResponse.redirect(loginUrl);
  }

  // 3) Otherwise, allow the route to continue
  return NextResponse.next();
}

// Only run middleware for specific routes
export const config = {
  matcher: ["/account/:path*", "/guest-area/:path*"]
};
</code></pre>

      <div class="card">
        <h3>What did the matcher do? üéØ</h3>
        <p>Instead of running on every route, middleware only runs for routes that match:</p>
        <ul>
          <li><code>/account</code> and anything below it</li>
          <li><code>/guest-area</code> and anything below it</li>
        </ul>
        <p class="mini">Result: less overhead and fewer unintended side effects.</p>
      </div>

      <h3>How this connects to Auth.js / NextAuth</h3>
      <p>Auth libraries typically store session info in cookies/headers. Middleware is ideal for authorization because it can read those cookies/headers <strong>before</strong> rendering a protected page.</p>
      <p class="mini">In the next lectures, you‚Äôll usually integrate middleware with your auth solution so it can reliably detect whether a user is authenticated.</p>
    </section>

    <section>
      <h2>7) Quick recap (exam-style)</h2>
      <ul>
        <li>üß© Middleware runs <strong>between request and response</strong>.</li>
        <li>‚è±Ô∏è It runs <strong>after request</strong>, <strong>before the route renders</strong>.</li>
        <li>üìç File location: <code>middleware.js</code> in the <strong>project root</strong>.</li>
        <li>üç™ Main power: read/set <strong>cookies & headers</strong>.</li>
        <li>üéØ Use <code>config.matcher</code> to limit which routes it runs on.</li>
        <li>‚Ü™Ô∏è Usually you <strong>redirect/rewrite</strong>; returning JSON is possible but less common.</li>
      </ul>

      <div class="callout">
        <div class="title">Why this matters for authorization üîê</div>
        <p>Authorization is about access control. Middleware is a clean way to protect routes <strong>globally</strong> without sprinkling the same checks into every page.</p>
      </div>

      <p class="mini">End of lecture reviewer ‚Äî next topic is applying middleware to protect the Guest Area route.</p>
    </section>
  </main>
</body>
</html>