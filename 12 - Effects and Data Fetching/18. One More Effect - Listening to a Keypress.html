

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>React ‚Äî Effects & Data Fetching: Listening to a Keypress (Esc) (Study Guide)</title>
  <style>
    :root {
      --bg: #ffffff;
      --text: #111111;
      --muted: #555555;
      --border: #e6e6e6;
      --soft: #f7f7f8;
      --soft2: #fbfbfc;
      --accent: #0b57d0;
      --ok: #0f7b0f;
      --warn: #b45309;
      --bad: #b42318;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: Arial, Helvetica, sans-serif;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: var(--sans);
      color: var(--text);
      background: var(--bg);
      line-height: 1.55;
      overflow-wrap: anywhere;
      word-break: normal;
      hyphens: auto;
    }

    /* Single-column page */
    .page {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px 18px 42px;
    }

    header {
      padding: 14px 14px 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--soft2);
    }

    .kicker {
      color: var(--muted);
      font-size: 12.5px;
      margin: 0 0 6px;
    }

    h1 {
      font-size: 22px;
      line-height: 1.25;
      margin: 0 0 10px;
    }

    .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 0;
      padding: 0;
      list-style: none;
      color: var(--muted);
      font-size: 12.5px;
    }

    .chip {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 999px;
      padding: 3px 10px;
    }

    h2 {
      font-size: 18px;
      margin: 18px 0 8px;
    }

    h3 {
      font-size: 15.5px;
      margin: 14px 0 8px;
    }

    p { margin: 8px 0; }
    ul, ol { margin: 8px 0 8px 20px; }
    li { margin: 4px 0; }

    .note, .tip, .warn, .danger {
      border: 1px solid var(--border);
      border-left-width: 6px;
      border-radius: 10px;
      padding: 10px 12px;
      background: var(--soft2);
      margin: 10px 0;
    }
    .note { border-left-color: var(--accent); }
    .tip { border-left-color: var(--ok); }
    .warn { border-left-color: var(--warn); }
    .danger { border-left-color: var(--bad); }

    .label {
      font-weight: 700;
      display: inline-block;
      margin-bottom: 4px;
    }

    code, pre {
      font-family: var(--mono);
      font-size: 12.5px;
    }

    pre {
      margin: 10px 0;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--soft);
      overflow: auto;
      white-space: pre;
    }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 16px 0;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .mini {
      font-size: 12.5px;
      color: var(--muted);
    }

    .checklist {
      padding-left: 0;
      list-style: none;
      margin-left: 0;
    }
    .checklist li {
      display: flex;
      gap: 8px;
      align-items: flex-start;
      margin: 6px 0;
    }
    .check {
      width: 18px;
      flex: 0 0 18px;
      text-align: center;
    }

    .qa {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: #fff;
      margin: 10px 0;
    }
    .qa .q { font-weight: 700; margin: 0 0 6px; }
    .qa .a { margin: 0; color: var(--muted); }

    footer {
      margin-top: 18px;
      color: var(--muted);
      font-size: 12.5px;
    }

    /* Print: A4, clean margins, no cutoffs */
    @page {
      size: A4;
      margin: 14mm 14mm 16mm;
    }

    @media print {
      body { background: #fff; }
      .page { max-width: none; padding: 0; }
      header, pre, .note, .tip, .warn, .danger, .qa {
        break-inside: avoid;
        page-break-inside: avoid;
      }
      a { color: inherit; text-decoration: none; }
    }
  </style>
</head>
<body>
  <main class="page">
    <header>
      <p class="kicker">üìö Study Guide (React Hooks) ‚Ä¢ Effects & Data Fetching ‚Ä¢ usePopcorn</p>
      <h1>Listening to a Global Keypress (Escape) with <code>useEffect</code> + Cleanup</h1>
      <ul class="meta">
        <li class="chip">üéØ Goal: Close Movie Details on <strong>Esc</strong></li>
        <li class="chip">üß† Core idea: Side effects live in <strong>useEffect</strong></li>
        <li class="chip">üßπ Must-have: <strong>removeEventListener</strong> cleanup</li>
      </ul>
    </header>

    <h2>What you‚Äôre building</h2>
    <p>
      Feature request: When the user opens a movie‚Äôs details, they should be able to press the
      <strong>Escape</strong> key to close the details panel (instead of only clicking the back button).
      ‚úÖ This requires listening to a <strong>global</strong> keypress event.
    </p>

    <div class="note">
      <div class="label">üß© Why this is a side effect</div>
      <p>
        You are interacting with the DOM directly via <code>document.addEventListener</code>.
        That‚Äôs outside React‚Äôs render cycle, so it must be done using <code>useEffect</code>
        (React‚Äôs ‚Äúescape hatch‚Äù).
      </p>
    </div>

    <h2>The correct place to attach the listener</h2>
    <p>
      You <em>could</em> attach the listener in <code>App</code>, but then it would keep listening
      even when no movie details are open, which is unnecessary.
    </p>
    <p>
      Best practice here: attach the listener in <strong>MovieDetails</strong>, so it only exists
      while that component instance is mounted.
    </p>

    <div class="tip">
      <div class="label">‚úÖ Principle</div>
      <p>
        Attach global listeners only when needed, and remove them when no longer needed.
        This prevents duplicate listeners and potential memory/performance issues.
      </p>
    </div>

    <h2>Common bug: ‚ÄúListeners are accumulating‚Äù üòµ</h2>
    <p>
      If you add a listener on mount but never remove it, every time MovieDetails mounts,
      you create <strong>one more listener</strong>. Later, pressing Esc triggers <strong>all</strong> of them.
      That‚Äôs why you might see multiple ‚Äúclosing‚Äù logs.
    </p>

    <div class="warn">
      <div class="label">‚ö†Ô∏è Key rule with DOM listeners</div>
      <p>
        <strong>The function reference must match</strong>.
        If you add a listener with an inline function, you can‚Äôt remove it later unless you
        remove the exact same function reference.
      </p>
    </div>

    <h2>Implementation (copy-ready)</h2>
    <p class="mini">This is the typical pattern: define a named handler, add it, then remove it in cleanup.</p>

    <pre><code>import { useEffect } from "react";

function MovieDetails({ selectedId, onCloseMovie }) {
  useEffect(() =&gt; {
    function handleKeyDown(e) {
      if (e.code === "Escape") {
        onCloseMovie();
      }
    }

    document.addEventListener("keydown", handleKeyDown);

    return () =&gt; {
      document.removeEventListener("keydown", handleKeyDown);
    };
  }, [onCloseMovie]);

  // ...rest of component
}</code></pre>

    <div class="note">
      <div class="label">üß† Why <code>[onCloseMovie]</code> is in the dependency array</div>
      <p>
        The handler uses <code>onCloseMovie</code>. React‚Äôs rules say: every value used inside the effect
        that can change (props/state/functions from props) must be listed.
      </p>
      <p>
        This keeps the effect synchronized and avoids bugs caused by ‚Äústale closures‚Äù (old values being
        remembered unexpectedly).
      </p>
    </div>

    <h2>How it works (timeline)</h2>
    <ul class="checklist">
      <li><span class="check">‚ë†</span><span><strong>MovieDetails mounts</strong> ‚Üí effect runs ‚Üí listener is attached üìå</span></li>
      <li><span class="check">‚ë°</span><span>User presses <strong>Esc</strong> ‚Üí handler runs ‚Üí calls <code>onCloseMovie()</code> ‚å®Ô∏è</span></li>
      <li><span class="check">‚ë¢</span><span><strong>MovieDetails unmounts</strong> ‚Üí cleanup runs ‚Üí listener is removed üßπ</span></li>
    </ul>

    <div class="divider"></div>

    <h2>Strict Mode note (React 18) üß™</h2>
    <p>
      In development with <strong>Strict Mode</strong>, React may run effects twice to help detect
      side-effect issues. This can make it look like your listener runs twice.
    </p>
    <div class="tip">
      <div class="label">‚úÖ What matters</div>
      <p>
        If you have a correct cleanup, you will not accumulate listeners. In production builds,
        the double-invocation behavior does not apply.
      </p>
    </div>

    <h2>Mini-checklist (what to verify)</h2>
    <div class="grid">
      <div class="qa">
        <p class="q">‚úÖ Does Esc close the details panel only when details are open?</p>
        <p class="a">Expected: Yes. When MovieDetails is not mounted, Esc does nothing.</p>
      </div>
      <div class="qa">
        <p class="q">‚úÖ Are you seeing exactly one close action per keypress?</p>
        <p class="a">Expected: Yes. If it closes multiple times, you likely forgot cleanup or mismatched the handler reference.</p>
      </div>
      <div class="qa">
        <p class="q">‚úÖ Is ESLint warning about missing dependencies gone?</p>
        <p class="a">Expected: Yes. If you use <code>onCloseMovie</code> inside the effect, it belongs in the array.</p>
      </div>
    </div>

    <h2>Common mistakes (and quick fixes)</h2>
    <div class="danger">
      <div class="label">‚ùå Mistake: inline function in add/remove</div>
      <pre><code>// BAD: these are different function references

document.addEventListener("keydown", (e) =&gt; {
  if (e.code === "Escape") onCloseMovie();
});

return () =&gt; {
  document.removeEventListener("keydown", (e) =&gt; {
    if (e.code === "Escape") onCloseMovie();
  });
};</code></pre>
      <p>
        ‚úÖ Fix: define <code>handleKeyDown</code> once, then reuse the same reference in both.
      </p>
    </div>

    <div class="warn">
      <div class="label">‚ö†Ô∏è Mistake: attaching the listener too high (e.g., App) without need</div>
      <p>
        It will keep listening even when MovieDetails is closed.
        ‚úÖ Fix: move the effect into MovieDetails if the listener is only relevant there.
      </p>
    </div>

    <h2>Quick practice questions</h2>
    <div class="qa">
      <p class="q">1) Why is <code>document.addEventListener</code> not allowed in render logic?</p>
      <p class="a">Because it‚Äôs a side effect that touches the DOM; render should stay pure and predictable.</p>
    </div>
    <div class="qa">
      <p class="q">2) When does the cleanup function run?</p>
      <p class="a">Before the next effect run (on re-render) and when the component unmounts.</p>
    </div>
    <div class="qa">
      <p class="q">3) What does ‚Äúsame function reference‚Äù mean for <code>removeEventListener</code>?</p>
      <p class="a">You must pass the exact same handler function object used in <code>addEventListener</code>, not a new inline function.</p>
    </div>

    <footer>
      <div class="divider"></div>
      <p>
        End of lecture notes: <strong>Listening to a Keypress (Esc)</strong>.
        Key takeaway: effects are for DOM/async side effects, and cleanups prevent leaks and duplicate work.
      </p>
    </footer>
  </main>
</body>
</html>