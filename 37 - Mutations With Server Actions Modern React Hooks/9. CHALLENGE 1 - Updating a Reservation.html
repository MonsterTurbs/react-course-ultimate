<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Next.js Server Actions â€” Challenge: Update a Reservation (Reviewer)</title>
  <style>
    :root {
      --bg: #ffffff;
      --text: #111111;
      --muted: #555555;
      --border: #e6e6e6;
      --soft: #fafafa;
      --soft2: #f4f6f8;
      --accent: #0b57d0;
      --ok: #0b7a3b;
      --warn: #8a5a00;
      --danger: #b42318;
      --codebg: #0b1020;
      --codetext: #e8eefc;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: Arial, Helvetica, sans-serif;
      line-height: 1.6;
      overflow-wrap: anywhere;
      word-break: normal;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    /* Single-column layout */
    .page {
      max-width: 820px;
      margin: 0 auto;
      padding: 24px 18px;
    }

    header {
      border: 1px solid var(--border);
      background: linear-gradient(180deg, var(--soft) 0%, #fff 100%);
      padding: 16px 16px 12px;
      border-radius: 12px;
    }

    h1 {
      font-size: 22px;
      margin: 0 0 6px;
      letter-spacing: 0.2px;
    }

    .subtitle {
      margin: 0;
      color: var(--muted);
      font-size: 13.5px;
    }

    .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .chip {
      font-size: 12.5px;
      background: var(--soft2);
      border: 1px solid var(--border);
      padding: 6px 10px;
      border-radius: 999px;
      color: #222;
      white-space: nowrap;
    }

    main { margin-top: 14px; }

    section {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 14px 6px;
      margin: 12px 0;
      background: #fff;
    }

    h2 {
      font-size: 16.5px;
      margin: 0 0 8px;
    }

    h3 {
      font-size: 14.5px;
      margin: 12px 0 6px;
    }

    p { margin: 0 0 10px; }

    ul, ol { margin: 0 0 10px 18px; padding: 0; }
    li { margin: 6px 0; }

    .callout {
      border-left: 4px solid var(--accent);
      background: #f6f9ff;
      padding: 10px 12px;
      border-radius: 10px;
      margin: 10px 0;
    }

    .callout.ok { border-left-color: var(--ok); background: #f3fbf6; }
    .callout.warn { border-left-color: var(--warn); background: #fff8ed; }
    .callout.danger { border-left-color: var(--danger); background: #fff5f5; }

    .kvs {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin: 10px 0 6px;
    }

    .kv {
      border: 1px solid var(--border);
      background: var(--soft);
      border-radius: 10px;
      padding: 10px 12px;
    }

    .kv b { display: inline-block; margin-bottom: 6px; }

    code, pre {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12.5px;
    }

    pre {
      background: var(--codebg);
      color: var(--codetext);
      padding: 12px 12px;
      border-radius: 12px;
      overflow: auto;
      border: 1px solid #192447;
      margin: 10px 0 12px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .hr {
      height: 1px;
      background: var(--border);
      margin: 10px 0;
    }

    .two-col {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .badge {
      display: inline-block;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      margin-right: 6px;
    }

    .badge.ok { border-color: #bfe8cf; background: #f1fbf5; color: #0b7a3b; }
    .badge.warn { border-color: #ffe0b2; background: #fff7ea; color: #8a5a00; }
    .badge.danger { border-color: #ffd1d1; background: #fff3f3; color: #b42318; }

    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* Print setup */
    @page {
      size: A4;
      margin: 14mm 12mm;
    }

    @media print {
      body { font-size: 11pt; }
      .page { max-width: none; padding: 0; }
      header, section { break-inside: avoid; }

      /* Do not print link URLs */
      a[href]::after { content: "" !important; }

      /* Avoid printing backgrounds too dark; keep code readable */
      pre {
        border: 1px solid #999;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>ğŸ§© Challenge 1: Updating a Reservation (Next.js + Server Actions)</h1>
      <p class="subtitle">
        Reviewer / study guide for implementing an â€œEdit Reservationâ€ flow using Server Actions, authentication + authorization checks, cache revalidation, redirecting, and a reusable Submit button with <code>useFormStatus</code>.
      </p>
      <div class="meta">
        <span class="chip">ğŸ“Œ Topic: Mutations with Server Actions</span>
        <span class="chip">ğŸ” Focus: Auth + Authorization</span>
        <span class="chip">ğŸ§  Key APIs: <code>revalidatePath</code>, <code>redirect</code></span>
        <span class="chip">â³ UX: <code>useFormStatus</code> (loading state)</span>
      </div>
    </header>

    <main>
      <section>
        <h2>ğŸ¯ What you are building</h2>
        <p>
          You will add an <b>Edit Reservation</b> page at a route like:
          <code>/account/reservations/edit/[bookingId]</code>.
          Users should be able to update only:
        </p>
        <ul>
          <li>ğŸ‘¥ <b>numGuests</b> (number of guests)</li>
          <li>ğŸ“ <b>observations</b> (notes / special requests)</li>
        </ul>
        <div class="callout warn">
          âš ï¸ This is a mutation. Treat it like backend work: validate inputs, authenticate user, and authorize access.
        </div>
      </section>

      <section>
        <h2>ğŸ§­ High-level checklist (the challenge steps)</h2>
        <ol>
          <li>ğŸ§± Create the route <code>/account/reservations/edit/[bookingId]</code> and add the starter <code>page.js</code>.</li>
          <li>ğŸ“¥ Fetch the booking you want to edit using <code>getBooking(bookingId)</code>.</li>
          <li>ğŸ  Fetch cabin capacity using <code>getCabin(booking.cabinId)</code> to render correct guest options.</li>
          <li>ğŸ§¾ Pre-populate the form with <code>defaultValue</code> for guests + observations.</li>
          <li>ğŸ§° Create a Server Action (recommended: in your central <code>actions.js</code>) like <code>updateBooking</code> / <code>updateReservation</code>.</li>
          <li>ğŸ•µï¸ Add authentication + authorization checks so users can edit <b>only their own</b> bookings.</li>
          <li>ğŸ«¥ Pass <code>bookingId</code> into the server action using a hidden input.</li>
          <li>ğŸ§¼ Revalidate the right caches with <code>revalidatePath</code>.</li>
          <li>â†©ï¸ Redirect back to <code>/account/reservations</code> after successful update.</li>
          <li>â³ Add a Submit button that shows â€œUpdatingâ€¦â€ via <code>useFormStatus</code>.</li>
        </ol>
      </section>

      <section>
        <h2>ğŸ§± Routing + Page structure</h2>
        <p>
          The edit button links to <code>/account/reservations/edit/[bookingId]</code>. Your job is to implement that route.
        </p>
        <div class="kvs">
          <div class="kv">
            <b>âœ… Folder convention</b>
            <div>
              <code>app/account/reservations/edit/[bookingId]/page.js</code>
            </div>
          </div>
          <div class="kv">
            <b>ğŸ” Reading the param</b>
            <div>
              In <code>page.js</code>, access it via <code>params.bookingId</code>.
            </div>
          </div>
        </div>
        <pre><code>// app/account/reservations/edit/[bookingId]/page.js
export default async function Page({ params }) {
  const bookingId = params.bookingId; // string from URL
  // ...fetch booking, render form
}
</code></pre>
        <div class="callout">
          ğŸ’¡ The param is a string. You often need <code>Number(bookingId)</code> for DB queries.
        </div>
      </section>

      <section>
        <h2>ğŸ“¥ Fetching data for pre-filled form</h2>
        <p>
          The edit form should show the existing booking data so the user edits from the current values.
        </p>
        <div class="two-col">
          <div class="kv">
            <b>1) Get the booking</b>
            <p class="subtitle">Use <code>getBooking(bookingId)</code> (single booking) instead of <code>getBookings</code> (list).</p>
          </div>
          <div class="kv">
            <b>2) Get cabin capacity</b>
            <p class="subtitle">Use the bookingâ€™s <code>cabinId</code> to fetch the cabin and render a correct <code>maxCapacity</code>.</p>
          </div>
        </div>
        <pre><code>const booking = await getBooking(Number(bookingId));
const { numGuests, observations, cabinId } = booking;

const cabin = await getCabin(cabinId);
const { maxCapacity } = cabin;
</code></pre>
        <div class="callout ok">
          âœ… Pre-fill inputs using <code>defaultValue</code>. This keeps the form simple and avoids client state.
        </div>
      </section>

      <section>
        <h2>ğŸ«¥ Passing the bookingId into the Server Action</h2>
        <p>
          Server Actions do not automatically know your URL params. The common â€œsingle valueâ€ solution is a hidden input.
        </p>
        <pre><code>&lt;form action={updateBooking}&gt;
  &lt;input type="hidden" name="bookingId" value={bookingId} /&gt;

  &lt;select name="numGuests" defaultValue={numGuests}&gt;...&lt;/select&gt;
  &lt;textarea name="observations" defaultValue={observations} /&gt;

  &lt;SubmitButton pendingLabel="Updating..."&gt;Update reservation&lt;/SubmitButton&gt;
&lt;/form&gt;
</code></pre>
        <div class="callout warn">
          âš ï¸ If you forget <code>name="bookingId"</code>, it will not show up in <code>formData</code>.
        </div>
      </section>

      <section>
        <h2>ğŸ§° Server Action: update the booking safely</h2>
        <p>
          A good Server Action structure is:
          <span class="badge ok">Authenticate</span>
          <span class="badge ok">Authorize</span>
          <span class="badge">Validate inputs</span>
          <span class="badge">Mutate DB</span>
          <span class="badge">Revalidate</span>
          <span class="badge">Redirect</span>
        </p>

        <h3>ğŸ” 1) Authentication</h3>
        <p>
          Make sure there is a session. If not, throw an error.
        </p>
        <pre><code>const session = await auth();
if (!session?.user) throw new Error("You must be logged in.");
</code></pre>

        <h3>ğŸ›¡ï¸ 2) Authorization (edit only your own booking)</h3>
        <p>
          The key idea: confirm the booking belongs to the currently logged-in user (guest).
          One simple strategy is to fetch all bookings for the guest and verify the ID is included.
        </p>
        <pre><code>const guestBookings = await getBookings(session.user.guestId);
const guestBookingIds = guestBookings.map(b =&gt; b.id);

if (!guestBookingIds.includes(bookingId)) {
  throw new Error("You are not allowed to edit this booking.");
}
</code></pre>
        <div class="callout danger">
          ğŸš¨ Without authorization checks, a malicious user could attempt to update other usersâ€™ bookings by sending a crafted POST request.
        </div>

        <h3>ğŸ§ª 3) Input validation (basic but important)</h3>
        <ul>
          <li>ğŸ‘¥ <code>numGuests</code> must be a number (usually within cabin capacity).</li>
          <li>ğŸ“ <code>observations</code> should be bounded (e.g., slice to 1000 chars) to avoid DB spam.</li>
        </ul>
        <pre><code>const numGuests = Number(formData.get("numGuests"));
const observations = String(formData.get("observations") ?? "").slice(0, 1000);

if (!Number.isFinite(numGuests) || numGuests &lt; 1) {
  throw new Error("Please provide a valid number of guests.");
}
</code></pre>

        <h3>ğŸ› ï¸ 4) Mutation (update in DB)</h3>
        <p>
          Use your Supabase update call (or your data service function) to update the row by ID.
        </p>
        <pre><code>const updateData = { numGuests, observations };

const { error } = await supabase
  .from("bookings")
  .update(updateData)
  .eq("id", bookingId);

if (error) throw new Error("Booking could not be updated.");
</code></pre>

        <h3>ğŸ§¼ 5) Cache revalidation + â†©ï¸ redirect</h3>
        <p>
          After a mutation, the UI might show stale data due to router/browser cache.
          Fix by revalidating the relevant paths, then redirect.
        </p>
        <pre><code>revalidatePath("/account/reservations");
revalidatePath(`/account/reservations/edit/${bookingId}`);

redirect("/account/reservations");
</code></pre>
        <div class="callout">
          ğŸ’¡ Rule of thumb: <b>revalidate first, redirect second</b>.
        </div>
      </section>

      <section>
        <h2>â³ Loading indicator for the submit button (useFormStatus)</h2>
        <p>
          When the form submits, show feedback like â€œUpdatingâ€¦â€ and disable the button.
          The recommended hook is <code>useFormStatus</code> (from <code>react-dom</code>), but it must be used in a component rendered <b>inside</b> the form.
        </p>

        <div class="callout ok">
          âœ… Best practice: create a reusable <code>SubmitButton</code> client component so you can use it across forms (profile update, reservation update, etc.).
        </div>

        <pre><code>// components/SubmitButton.js
"use client";

import { useFormStatus } from "react-dom";

export default function SubmitButton({ children, pendingLabel = "Working..." }) {
  const { pending } = useFormStatus();

  return (
    &lt;button
      type="submit"
      disabled={pending}
      className="btn"
      aria-disabled={pending}
    &gt;
      {pending ? pendingLabel : children}
    &lt;/button&gt;
  );
}
</code></pre>

        <div class="callout warn">
          âš ï¸ Because it uses a hook, <code>SubmitButton</code> must be a Client Component (<code>"use client"</code>).
        </div>
      </section>

      <section>
        <h2>ğŸ§  Quick mental model to remember</h2>
        <ul>
          <li>ğŸ§¾ Forms + Server Actions = mutation without client state</li>
          <li>ğŸ” Always verify <b>who</b> is doing the action (auth)</li>
          <li>ğŸ›¡ï¸ Always verify <b>what theyâ€™re allowed</b> to change (authorization)</li>
          <li>ğŸ§¼ After mutation, refresh UI with <code>revalidatePath</code></li>
          <li>â†©ï¸ Use <code>redirect</code> for a clean user flow after success</li>
          <li>â³ Use <code>useFormStatus</code> for form submission loading state</li>
        </ul>
      </section>

      <section>
        <h2>âœ… Self-check questions</h2>
        <ol>
          <li>Do I have the correct route: <code>/account/reservations/edit/[bookingId]</code>?</li>
          <li>Does the edit page prefill the form using <code>defaultValue</code>?</li>
          <li>Does the form send <code>bookingId</code> via a hidden field?</li>
          <li>Does the Server Action throw errors if the user is not logged in?</li>
          <li>Does the Server Action prevent editing someone elseâ€™s booking?</li>
          <li>Do I convert numeric values from <code>formData</code> strings to numbers?</li>
          <li>Do I revalidate the correct paths before redirecting?</li>
          <li>Does the submit button show â€œUpdatingâ€¦â€ while pending?</li>
        </ol>
      </section>

      <section>
        <h2>ğŸ§¾ Mini glossary</h2>
        <ul>
          <li>ğŸ” <b>Mutation</b>: changing data (create/update/delete) instead of just reading it.</li>
          <li>ğŸ§© <b>Server Action</b>: an async function that runs only on the server; Next.js creates an endpoint behind the scenes.</li>
          <li>ğŸ§¼ <b>Revalidation</b>: clearing cached UI/data so fresh data is fetched and rendered.</li>
          <li>ğŸ•µï¸ <b>Authorization</b>: checking permissions (e.g., â€œis this booking owned by this user?â€).</li>
          <li>â³ <b>useFormStatus</b>: provides form submission state (pending) for Server Action forms.</li>
        </ul>
      </section>

      <section>
        <h2>ğŸ Output expectation</h2>
        <p>
          When done, users should be able to:
        </p>
        <ul>
          <li>âœï¸ Click â€œEditâ€ on a reservation</li>
          <li>ğŸ“ Update guests/observations and submit</li>
          <li>â³ See â€œUpdatingâ€¦â€ briefly</li>
          <li>â†©ï¸ Return to reservations page automatically</li>
          <li>âœ… See fresh updated values without stale-cache confusion</li>
        </ul>
      </section>

    </main>
  </div>
</body>
</html>
