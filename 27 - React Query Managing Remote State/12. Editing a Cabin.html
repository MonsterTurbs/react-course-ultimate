<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>React Query + Supabase â€” Editing a Cabin (Reviewer / Study Guide)</title>
  <style>
    :root {
      --bg: #ffffff;
      --text: #111111;
      --muted: #555555;
      --border: #e6e6e6;
      --soft: #fafafa;
      --code-bg: #f6f8fa;
      --code-border: #d0d7de;
      --accent: #1a73e8;
    }

    /* Base */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: Arial, Helvetica, sans-serif;
      line-height: 1.6;
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    /* Single-column page container */
    .page {
      max-width: 820px; /* readable on screen; print will still be A4 */
      margin: 0 auto;
      padding: 24px;
    }

    header {
      border: 1px solid var(--border);
      background: var(--soft);
      padding: 16px 18px;
      border-radius: 12px;
    }

    h1 {
      margin: 0 0 6px 0;
      font-size: 22px;
      letter-spacing: 0.2px;
    }

    .subtitle {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

    .meta {
      margin-top: 10px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
      color: var(--muted);
      font-size: 13px;
    }

    main { margin-top: 16px; }

    section {
      margin-top: 14px;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 16px;
    }

    h2 {
      margin: 0 0 10px 0;
      font-size: 16px;
    }

    h3 {
      margin: 14px 0 8px 0;
      font-size: 14px;
    }

    p { margin: 8px 0; }

    ul {
      margin: 8px 0 0 18px;
      padding: 0;
    }

    li { margin: 6px 0; }

    .callout {
      border-left: 4px solid var(--accent);
      background: #f3f7ff;
      padding: 10px 12px;
      border-radius: 10px;
      margin: 10px 0;
    }

    .warn {
      border-left-color: #b42318;
      background: #fff5f5;
    }

    .ok {
      border-left-color: #067647;
      background: #f2fff8;
    }

    code, pre {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12.5px;
    }

    pre {
      background: var(--code-bg);
      border: 1px solid var(--code-border);
      border-radius: 10px;
      padding: 12px;
      overflow: auto;
      white-space: pre-wrap; /* avoid cut-off on print */
      word-break: break-word;
      margin: 10px 0;
    }

    .kbd {
      display: inline-block;
      padding: 1px 6px;
      border: 1px solid var(--border);
      border-bottom-width: 2px;
      border-radius: 6px;
      background: #fff;
      font-size: 12px;
      color: #222;
      vertical-align: baseline;
    }

    .tiny { font-size: 12.5px; color: var(--muted); }

    /* Print settings */
    @page {
      size: A4;
      margin: 14mm;
    }

    @media print {
      body {
        background: #fff;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .page { padding: 0; max-width: none; }

      a[href]::after { content: ""; } /* do not print URLs */

      section, header {
        break-inside: avoid;
        page-break-inside: avoid;
      }

      pre {
        border-color: #cfcfcf;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>ğŸ¡ Editing a Cabin (React Query + Supabase + React Hook Form)</h1>
      <p class="subtitle">Reviewer / Study Guide â€” beginner-friendly, print-ready (single column, A4)</p>
      <div class="meta">
        <div>ğŸ§© Topic: Reuse <strong>CreateCabinForm</strong> for both <strong>Create</strong> and <strong>Edit</strong> flows</div>
        <div>ğŸ§  Focus: defaultValues, edit vs create session, image handling (URL vs FileList), and React Query mutations</div>
      </div>
    </header>

    <main>
      <section>
        <h2>âœ… What you will build in this lecture</h2>
        <ul>
          <li>â• Add an <strong>Edit</strong> button to each cabin row and show the form under that row (temporary UI; later it becomes a modal).</li>
          <li>â™»ï¸ Reuse the same <strong>CreateCabinForm</strong> component for editing by passing <code>cabinToEdit</code>.</li>
          <li>ğŸ§¾ Prefill the form inputs using <strong>React Hook Form</strong> <code>defaultValues</code>.</li>
          <li>ğŸ–¼ï¸ Make image upload optional while editing (keep existing image unless user chooses a new file).</li>
          <li>ğŸ§° Reuse one service function for both create and edit (often named <code>createEditCabin</code>).</li>
          <li>âš¡ Use <strong>React Query</strong> <code>useMutation</code> + <code>invalidateQueries</code> to auto-refresh the UI.</li>
        </ul>

        <div class="callout ok">
          ğŸ˜€ Real-world note: This lecture is â€œmessy on purpose.â€ Debugging and edge-cases are normal in real apps.
        </div>
      </section>

      <section>
        <h2>ğŸ§± Step 1 â€” Add an Edit button and toggle the form per row</h2>
        <p>
          In <strong>CabinRow</strong>, add another button (Edit) and a temporary state flag (e.g. <code>showForm</code>) that
          decides whether the form is rendered under the row.
        </p>

        <pre>// CabinRow.jsx (concept)
const [showForm, setShowForm] = useState(false);

return (
  <>
    <TableRow role="row">
      {/* ...existing cells... */}

      <div>
        <button onClick={() => setShowForm((s) => !s)}>Edit</button>
        <button /* existing Delete */>Delete</button>
      </div>
    </TableRow>

    {showForm && <CreateCabinForm cabinToEdit={cabin} />}
  </>
);</pre>

        <div class="callout">
          ğŸ™‚ Why fragment <code>&lt;&gt;...&lt;/&gt;</code>? Because you are returning two siblings: the row and the form.
        </div>
      </section>

      <section>
        <h2>ğŸ§© Step 2 â€” Detect â€œedit modeâ€ inside CreateCabinForm</h2>
        <p>
          The trick is to pass a cabin object into the form. If it exists, you are editing. If not, you are creating.
        </p>

        <pre>// CreateCabinForm.jsx (concept)
export default function CreateCabinForm({ cabinToEdit = {} }) {
  const { id: editId, ...editValues } = cabinToEdit;
  const isEditSession = Boolean(editId);

  // ...
}</pre>

        <div class="callout ok">
          ğŸ˜„ Pattern: <code>const isEditSession = Boolean(editId)</code> makes the intent obvious.
        </div>
      </section>

      <section>
        <h2>ğŸ§¾ Step 3 â€” Prefill inputs using React Hook Form defaultValues</h2>
        <p>
          React Hook Form supports <code>defaultValues</code>. When editing, provide the cabin values. When creating, pass an empty object.
        </p>

        <pre>const {
  register,
  handleSubmit,
  reset,
  getValues,
  formState: { errors },
} = useForm({
  defaultValues: isEditSession ? editValues : {},
});</pre>

        <p class="tiny">
          ğŸ“ This pre-fills text/number inputs. The file input cannot be prefilled by browsers (for security reasons).
        </p>

        <h3>ğŸ”¤ Update labels and button text based on mode</h3>
        <pre>&lt;h2&gt;{isEditSession ? "Edit cabin" : "Create new cabin"}&lt;/h2&gt;

&lt;button disabled={isWorking}&gt;
  {isEditSession ? "Edit cabin" : "Add cabin"}
&lt;/button&gt;</pre>
      </section>

      <section>
        <h2>ğŸ–¼ï¸ Step 4 â€” Make image optional on edit</h2>
        <p>
          When editing, you usually want to keep the existing image URL unless the user selects a new file.
          Therefore, image should be <strong>required only when creating</strong>.
        </p>

        <pre>// Image field validation (concept)
&lt;input
  id="image"
  type="file"
  accept="image/*"
  {...register("image", {
    required: isEditSession ? false : "Cabin photo is required",
  })}
/&gt;</pre>

        <div class="callout warn">
          âš ï¸ Important: Even with <code>defaultValues</code>, file inputs stay empty. This is expected.
        </div>
      </section>

      <section>
        <h2>ğŸ” Step 5 â€” Reuse one service: create + edit in the same function</h2>
        <p>
          The goal is to avoid duplicating logic, especially the image upload and rollback behavior.
          A common approach is a single function like <code>createEditCabin(newCabin, id)</code>.
        </p>

        <h3>âœ… Key idea: build a query, then execute it</h3>
        <pre>// apiCabins.js (concept)
export async function createEditCabin(newCabin, id) {
  // 1) Decide whether we already have an image URL or a new file
  const hasImagePath = newCabin.image?.startsWith?.(supabaseUrl);

  const imageName = hasImagePath
    ? null
    : `${Math.random()}-${newCabin.image.name}`.replaceAll("/", "");

  const imagePath = hasImagePath
    ? newCabin.image
    : `${supabaseUrl}/storage/v1/object/public/cabin-images/${imageName}`;

  // 2) Create base query
  let query = supabase.from("cabins");

  // 3) Create vs Edit
  if (!id) {
    query = query.insert([{ ...newCabin, image: imagePath }]);
  }

  if (id) {
    query = query.update({ ...newCabin, image: imagePath }).eq("id", id);
  }

  // 4) Get created/updated row back
  const { data, error } = await query.select().single();
  if (error) throw new Error("Cabin could not be created/edited");

  // 5) If there is a NEW file, upload it (skip upload if we already had an image URL)
  if (!hasImagePath) {
    const { error: storageError } = await supabase.storage
      .from("cabin-images")
      .upload(imageName, newCabin.image);

    if (storageError) {
      // rollback: remove cabin row if storage failed
      await supabase.from("cabins").delete().eq("id", data.id);
      throw new Error("Cabin image could not be uploaded; cabin was not saved");
    }
  }

  return data;
}</pre>

        <div class="callout warn">
          ğŸ˜µ Common bug: forgetting to reassign <code>query</code>.
          You must do <code>query = query.insert(...)</code> / <code>query = query.update(...)</code>, otherwise nothing runs.
        </div>

        <div class="callout">
          ğŸ§  Why <code>.select().single()</code>? Insert/update might not return the row unless you request it.
        </div>
      </section>

      <section>
        <h2>ğŸ§ª Step 6 â€” Handle â€œimage is URLâ€ vs â€œimage is FileListâ€ in the form</h2>
        <p>
          In edit mode, <code>data.image</code> can be either:
        </p>
        <ul>
          <li>ğŸ”— A string URL (existing image path), or</li>
          <li>ğŸ“ A FileList (when the user chooses a new file).</li>
        </ul>

        <pre>// CreateCabinForm.jsx (concept)
function onSubmit(data) {
  const image =
    typeof data.image === "string" ? data.image : data.image[0];

  const newCabinData = { ...data, image };

  if (isEditSession) {
    editCabin({ newCabinData, id: editId });
  } else {
    createCabin(newCabinData);
  }
}</pre>

        <div class="callout warn">
          âš ï¸ Remember: FileList is not a normal array, so <code>.at(0)</code> may fail depending on environment.
          Safest is <code>data.image[0]</code>.
        </div>
      </section>

      <section>
        <h2>âš¡ Step 7 â€” React Query mutations: create vs edit</h2>
        <p>
          You typically keep two mutations for clarity, even if they use the same service function.
          After success, invalidate the cabins query so the table re-fetches.
        </p>

        <pre>// CreateCabinForm.jsx (concept)
const queryClient = useQueryClient();

const { mutate: createCabin, isLoading: isCreating } = useMutation({
  mutationFn: (newCabinData) => createEditCabin(newCabinData),
  onSuccess: () => {
    // toast.success("Cabin successfully created");
    queryClient.invalidateQueries({ queryKey: ["cabins"] });
    reset();
  },
  onError: (err) => {
    // toast.error(err.message);
  },
});

const { mutate: editCabin, isLoading: isEditing } = useMutation({
  mutationFn: ({ newCabinData, id }) => createEditCabin(newCabinData, id),
  onSuccess: () => {
    // toast.success("Cabin successfully edited");
    queryClient.invalidateQueries({ queryKey: ["cabins"] });
    reset();
  },
  onError: (err) => {
    // toast.error(err.message);
  },
});

const isWorking = isCreating || isEditing;</pre>

        <div class="callout ok">
          ğŸ˜ Result: UI refreshes automatically after create/edit because the â€œcabinsâ€ query is invalidated.
        </div>
      </section>

      <section>
        <h2>ğŸ Debugging checklist (the lectureâ€™s common pitfalls)</h2>
        <ul>
          <li>ğŸ§© <strong>Query key mismatch</strong>: invalidate <code>["cabins"]</code> if your fetch query uses <code>["cabins"]</code>.</li>
          <li>ğŸ§  <strong>Query reassignment</strong>: must write <code>query = query.insert(...)</code> or <code>query = query.update(...)</code>.</li>
          <li>ğŸ”¤ <strong>Wrong variable name</strong>: use <code>supabaseUrl</code> consistently (typos can break image detection).</li>
          <li>ğŸ“ <strong>FileList handling</strong>: prefer <code>data.image[0]</code> over <code>.at(0)</code>.</li>
          <li>ğŸ–¼ï¸ <strong>Broken image after edit</strong>: ensure that when no new file is selected, you keep the existing URL.</li>
          <li>ğŸ” <strong>RLS policies</strong>: update requires correct policies; otherwise Supabase will silently reject.</li>
        </ul>

        <div class="callout">
          ğŸ™‚ If something â€œdoes nothing,â€ verify: mutation runs â†’ service receives correct args â†’ Supabase query executes â†’ query invalidates â†’ UI re-renders.
        </div>
      </section>

      <section>
        <h2>ğŸ§  Quick recap</h2>
        <ul>
          <li>â™»ï¸ You reused one form component for create + edit by passing <code>cabinToEdit</code>.</li>
          <li>ğŸ§¾ You prefilled values via <code>useForm({ defaultValues })</code>.</li>
          <li>ğŸ–¼ï¸ You handled the â€œimage URL vs FileListâ€ problem with conditional logic.</li>
          <li>âš¡ You used React Query mutations + <code>invalidateQueries</code> to refresh the cabin table automatically.</li>
          <li>ğŸ› ï¸ You practiced real debugging (typos, query reassignment, image path handling).</li>
        </ul>

        <div class="callout ok">
          ğŸ˜€ Next lecture preview: extracting these mutations into custom hooks to keep components clean.
        </div>
      </section>

      <p class="tiny" style="margin-top: 12px;">
        Print tip: Use your browser print dialog â†’ Paper size A4 â†’ Margins default. This page is designed to avoid cut-off and keep clean spacing.
      </p>
    </main>
  </div>
</body>
</html>
