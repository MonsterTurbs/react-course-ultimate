

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Removing Reservations Immediately ‚Äî useOptimistic (Next.js Server Actions)</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#111111;
      --muted:#555555;
      --border:#e6e6e6;
      --panel:#fafafa;
      --chip:#f3f4f6;
      --accent:#0b57d0;
      --ok:#137333;
      --warn:#b06000;
      --bad:#b00020;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: Arial, Helvetica, sans-serif;
      line-height:1.6;
      overflow-wrap:anywhere;
      word-break: normal;
    }

    /* Single-column page */
    .page{
      max-width: 900px;
      margin: 0 auto;
      padding: 28px 18px 48px;
    }

    header{
      border:1px solid var(--border);
      background: linear-gradient(180deg, #ffffff 0%, var(--panel) 100%);
      border-radius: 12px;
      padding: 18px 18px 14px;
    }

    h1{
      margin:0 0 6px;
      font-size: 22px;
      letter-spacing: .2px;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size: 13.5px;
    }

    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top: 12px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--chip);
      border:1px solid var(--border);
      font-size: 12.5px;
      color:#222;
    }

    main{ margin-top: 16px; }

    section{
      margin-top: 16px;
      border:1px solid var(--border);
      border-radius: 12px;
      background:#fff;
      padding: 16px 16px 12px;
    }

    h2{
      margin: 0 0 8px;
      font-size: 18px;
    }

    h3{
      margin: 14px 0 6px;
      font-size: 15px;
    }

    p{ margin: 8px 0; }
    ul,ol{ margin: 8px 0 10px 22px; }
    li{ margin: 6px 0; }

    .callout{
      border-left: 4px solid var(--accent);
      background: #f6f9ff;
      padding: 10px 12px;
      border-radius: 10px;
      margin: 10px 0;
    }

    .callout.ok{ border-left-color: var(--ok); background:#f4fbf6; }
    .callout.warn{ border-left-color: var(--warn); background:#fff7ef; }
    .callout.bad{ border-left-color: var(--bad); background:#fff5f7; }

    .k{
      font-family: var(--mono);
      font-size: 12.5px;
      background: #0f172a;
      color: #e5e7eb;
      padding: 1px 6px;
      border-radius: 6px;
      white-space: nowrap;
    }

    pre{
      margin: 10px 0;
      padding: 12px;
      border:1px solid var(--border);
      border-radius: 10px;
      background: #0b1020;
      color: #e8eefc;
      overflow:auto;
      font-family: var(--mono);
      font-size: 12.5px;
      line-height: 1.55;
    }

    code{ font-family: var(--mono); }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .table{
      width:100%;
      border-collapse: collapse;
      margin: 10px 0 6px;
      font-size: 13px;
    }
    .table th,.table td{
      border:1px solid var(--border);
      padding: 8px 9px;
      vertical-align: top;
      text-align:left;
    }
    .table th{ background: var(--panel); }

    .hr{
      height:1px;
      background:var(--border);
      margin: 12px 0;
    }

    a{ color: var(--accent); text-decoration: none; }
    a:hover{ text-decoration: underline; }

    /* Print styles (A4, no link URLs) */
    @page{ size: A4; margin: 14mm 14mm; }
    @media print{
      body{ background:#fff; }
      .page{ max-width:none; padding:0; }
      header, section{ border: 1px solid #ddd; box-shadow:none; }
      a{ color: #000; text-decoration:none; }
      a[href]::after{ content: "" !important; }
      .chip{ background:#fff; }
      pre{ page-break-inside: avoid; }
      section{ page-break-inside: avoid; }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>üß† Removing Reservations Immediately ‚Äî Optimistic UI with <span class="k">useOptimistic</span></h1>
      <p class="subtitle">
        Study guide (Next.js + React Server Components). Focus: making ‚ÄúDelete reservation‚Äù feel instant by updating the UI <em>before</em> the server finishes.
      </p>
      <div class="meta">
        <span class="chip">‚öôÔ∏è Topic: Server Actions + Client UI</span>
        <span class="chip">üöÄ Goal: Snappy UX (perceived performance)</span>
        <span class="chip">ü™ù Hook: <span class="k">useOptimistic</span></span>
        <span class="chip">üß© Related: <span class="k">useTransition</span>, cache revalidation</span>
      </div>
    </header>

    <main>
      <section>
        <h2>1) Big Idea: What is Optimistic UI?</h2>
        <p>
          <strong>Optimistic UI</strong> is a UX technique where we update the screen <em>immediately</em> as if an async operation succeeded, while the real work is still running in the background.
        </p>
        <div class="callout">
          <p><strong>üôÇ Why it feels fast:</strong> the user sees instant feedback (item disappears), so the app feels responsive even if the network/server is slow.</p>
        </div>
        <p>
          In this lecture‚Äôs example, when a guest clicks <strong>Delete</strong>, we remove that reservation card right away‚Äîeven though the server action is still deleting it in Supabase.
        </p>
        <div class="callout warn">
          <p><strong>‚ö†Ô∏è Important:</strong> ‚ÄúOptimistic‚Äù means we <em>assume success</em>. If deletion fails, we must restore the UI (rollback).</p>
        </div>
      </section>

      <section>
        <h2>2) Why we need a Client Component</h2>
        <p>
          Hooks like <span class="k">useOptimistic</span> run only on the client, so the reservations list must be rendered by a <strong>Client Component</strong>.
        </p>
        <ol>
          <li>Keep data fetching on the server page (Server Component).</li>
          <li>Move the <em>rendering of the list</em> into a new client component (e.g., <span class="k">ReservationList</span>).</li>
          <li>Pass <span class="k">bookings</span> from server ‚Üí client as props.</li>
        </ol>

        <h3>‚úÖ Server page: fetch bookings then render the client list</h3>
        <pre><code>// app/account/reservations/page.js (Server Component)
import { auth } from "@/app/_lib/auth";
import { getBookings } from "@/app/_lib/data-service";
import ReservationList from "@/app/_components/ReservationList";

export default async function Page() {
  const session = await auth();
  const bookings = await getBookings(session.user.guestId);

  return (
    &lt;div&gt;
      &lt;h2&gt;Your reservations&lt;/h2&gt;
      &lt;ReservationList bookings={bookings} /&gt;
    &lt;/div&gt;
  );
}</code></pre>

        <div class="callout ok">
          <p><strong>üí° Pattern:</strong> Fetch on server, render interactive UI on client. This keeps sensitive logic server-side but still allows a great UX.</p>
        </div>
      </section>

      <section>
        <h2>3) Anatomy of <span class="k">useOptimistic</span></h2>
        <p>
          You‚Äôll think in <strong>two states</strong>:
        </p>
        <ul>
          <li><strong>Actual state</strong>: the real bookings list from the server (source of truth).</li>
          <li><strong>Optimistic state</strong>: what we show temporarily while async work is pending.</li>
        </ul>

        <table class="table">
          <thead>
            <tr>
              <th>Hook Input</th>
              <th>Meaning</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><span class="k">useOptimistic(bookings, updaterFn)</span></td>
              <td>
                <span class="k">bookings</span> is the initial/current state; <span class="k">updaterFn</span> computes the next optimistic state.
              </td>
            </tr>
          </tbody>
        </table>

        <table class="table">
          <thead>
            <tr>
              <th>Hook Output</th>
              <th>Meaning</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><span class="k">optimisticBookings</span></td>
              <td>The list you render in the UI (temporarily modified during pending async work).</td>
            </tr>
            <tr>
              <td><span class="k">optimisticDelete</span></td>
              <td>A function you call to trigger the optimistic update.</td>
            </tr>
          </tbody>
        </table>
      </section>

      <section>
        <h2>4) Implementing Optimistic Delete (step-by-step)</h2>

        <h3>Step A ‚Äî Create <span class="k">ReservationList</span> as a Client Component</h3>
        <pre><code>// app/_components/ReservationList.js
"use client";

import { useOptimistic } from "react";
import ReservationCard from "@/app/_components/ReservationCard";
import { deleteReservation } from "@/app/_lib/actions";

export default function ReservationList({ bookings }) {
  // 1) create optimistic state
  const [optimisticBookings, optimisticDelete] = useOptimistic(
    bookings,
    (currentBookings, bookingId) => {
      // 2) compute next optimistic state
      return currentBookings.filter(b => b.id !== bookingId);
    }
  );

  // 3) handle delete: optimistic first, then real server action
  async function handleDelete(bookingId) {
    optimisticDelete(bookingId);            // ‚úÖ UI updates instantly
    await deleteReservation(bookingId);     // ‚úÖ real deletion (server)
  }

  return (
    &lt;ul className="space-y-6"&gt;
      {optimisticBookings.map(booking =&gt; (
        &lt;ReservationCard
          key={booking.id}
          booking={booking}
          onDelete={handleDelete}
        /&gt;
      ))}
    &lt;/ul&gt;
  );
}</code></pre>

        <div class="callout">
          <p><strong>üß© What changed?</strong> You render <span class="k">optimisticBookings</span> instead of <span class="k">bookings</span>, and call <span class="k">optimisticDelete(id)</span> immediately on click.</p>
        </div>

        <h3>Step B ‚Äî ‚ÄúProp drilling‚Äù the delete handler to the button</h3>
        <p>
          The delete button lives deeper in the tree (e.g., inside <span class="k">ReservationCard</span> and a <span class="k">DeleteReservation</span> button component). We pass an <span class="k">onDelete</span> prop down.
        </p>
        <pre><code>// ReservationCard.jsx (can be server or client depending on your app)
export default function ReservationCard({ booking, onDelete }) {
  const { id } = booking;

  return (
    &lt;li&gt;
      {/* ... reservation UI ... */}
      &lt;DeleteReservation bookingId={id} onDelete={onDelete} /&gt;
    &lt;/li&gt;
  );
}</code></pre>

        <pre><code>// DeleteReservation.jsx (Client Component)
"use client";

import { useTransition } from "react";
import SpinnerMini from "@/app/_components/SpinnerMini";

export default function DeleteReservation({ bookingId, onDelete }) {
  const [isPending, startTransition] = useTransition();

  function handleClick() {
    // optional confirm
    // if (!confirm("Delete this reservation?") ) return;

    startTransition(() => onDelete(bookingId));
  }

  return (
    &lt;button onClick={handleClick} disabled={isPending}&gt;
      {!isPending ? "Delete" : &lt;span className="mx-auto"&gt;&lt;SpinnerMini /&gt;&lt;/span&gt;}
    &lt;/button&gt;
  );
}</code></pre>

        <div class="callout ok">
          <p><strong>‚úÖ Why keep <span class="k">useTransition</span>?</strong> Even with optimistic UI, the server action still runs. A subtle pending state can prevent double-clicks and keeps the UI safe.</p>
        </div>
      </section>

      <section>
        <h2>5) Rollback: What happens when the delete fails?</h2>
        <p>
          A core benefit of <span class="k">useOptimistic</span> is rollback behavior. If the async operation throws an error, React can restore the previous UI state.
        </p>
        <div class="callout warn">
          <p><strong>üß™ Testing trick:</strong> add an artificial delay and throw an error to confirm the item disappears immediately and then reappears.</p>
        </div>

        <pre><code>// inside deleteReservation server action (testing only)
await new Promise(r =&gt; setTimeout(r, 2000));
throw new Error("Simulated failure");</code></pre>

        <ul>
          <li>Click Delete ‚Üí item disappears instantly (optimistic UI)</li>
          <li>After 2 seconds ‚Üí error occurs ‚Üí item returns (rollback)</li>
        </ul>

        <div class="callout bad">
          <p><strong>Security reminder üîí:</strong> Your server action must still enforce authorization (user can only delete their own booking). Optimistic UI does not replace backend rules.</p>
        </div>
      </section>

      <section>
        <h2>6) Where cache revalidation fits</h2>
        <p>
          Your server action (e.g., <span class="k">deleteReservation</span>) should still revalidate the reservations route so server data stays consistent across navigation.
        </p>
        <pre><code>// app/_lib/actions.js
"use server";

import { auth } from "@/app/_lib/auth";
import { getBookings } from "@/app/_lib/data-service";
import { revalidatePath } from "next/cache";
import supabase from "@/app/_lib/supabase";

export async function deleteReservation(bookingId) {
  const session = await auth();
  if (!session) throw new Error("You must be logged in");

  // Authorization: ensure booking belongs to this guest
  const guestBookings = await getBookings(session.user.guestId);
  const guestBookingIds = guestBookings.map(b =&gt; b.id);
  if (!guestBookingIds.includes(bookingId)) {
    throw new Error("You are not allowed to delete this booking");
  }

  const { error } = await supabase
    .from("bookings")
    .delete()
    .eq("id", bookingId);

  if (error) throw new Error("Could not delete booking");

  revalidatePath("/account/reservations");
}</code></pre>

        <div class="callout">
          <p><strong>üß† Mental model:</strong> Optimistic UI improves perceived speed <em>now</em>, while revalidation ensures correctness <em>everywhere</em> (especially after navigation).</p>
        </div>
      </section>

      <section>
        <h2>7) Extra UX: Loading UI for nested routes</h2>
        <p>
          The lecture mentions copying <span class="k">loading.js</span> into the <span class="k">account</span> route so nested pages show a spinner while streaming.
        </p>
        <div class="callout ok">
          <p><strong>‚úÖ Outcome:</strong> When navigating to account-related pages, users see a consistent loading indicator instead of ‚Äúnothing happening‚Äù.</p>
        </div>
      </section>

      <section>
        <h2>8) Quick Checklist (review before moving on)</h2>
        <ul>
          <li>‚úÖ Moved reservations list into a Client Component (<span class="k">ReservationList</span>)</li>
          <li>‚úÖ Used <span class="k">useOptimistic</span> to remove an item immediately</li>
          <li>‚úÖ Called server action after the optimistic update</li>
          <li>‚úÖ Rollback verified by simulating an error</li>
          <li>‚úÖ Server-side authorization still enforced</li>
          <li>‚úÖ Revalidated <span class="k">/account/reservations</span> after deletion</li>
          <li>‚úÖ Optional: used <span class="k">useTransition</span> to disable button/spinner</li>
        </ul>
      </section>

      <section>
        <h2>9) Mini FAQ</h2>
        <div class="grid">
          <div class="callout">
            <p><strong>Q:</strong> Do I still need spinners if I use optimistic UI?</p>
            <p><strong>A:</strong> Often you can reduce them. But you may still want a subtle pending state to prevent double clicks and show ‚Äúwork in progress‚Äù.</p>
          </div>
          <div class="callout">
            <p><strong>Q:</strong> Is optimistic UI safe?</p>
            <p><strong>A:</strong> UX-safe, yes‚Äîif you handle failures (rollback) and keep backend authorization strict.</p>
          </div>
          <div class="callout">
            <p><strong>Q:</strong> What‚Äôs the simplest optimistic delete update function?</p>
            <p><strong>A:</strong> Filter out the item: <span class="k">current.filter(x =&gt; x.id !== id)</span>.</p>
          </div>
        </div>
      </section>

      <section>
        <h2>10) Key Takeaways</h2>
        <ul>
          <li>‚ö° Optimistic UI makes apps feel fast by updating the UI before the server finishes.</li>
          <li>ü™ù <span class="k">useOptimistic</span> is designed for ‚Äútemporary UI state while async work is pending‚Äù.</li>
          <li>üîí Never rely on client UI for security‚Äîalways authorize in server actions.</li>
          <li>üßº Use <span class="k">revalidatePath</span> to keep server-rendered data consistent after mutations.</li>
        </ul>
      </section>

    </main>
  </div>
</body>
</html>